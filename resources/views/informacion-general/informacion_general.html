<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Creación plan</title>
        <!-- Enlazar CSS de Font Awesome localmente -->
        <link rel="stylesheet" href="/assets/fontawesome/css/all.min.css" />
        <!-- Enlazar Bootstrap CSS -->
        <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" />
        <!-- Enlazar DataTables CSS -->
        <link rel="stylesheet" href="/assets/DataTables/datatables.min.css" />
        <!-- Enlazar CSS -->
        <link rel="stylesheet" href="/assets/css/forms.css" />

        <!-- Incluir el CSS de Toastify -->
        <link rel="stylesheet" href="/assets/toastify/toastify.css" />
        <!-- Incluir el JS de Toastify -->
        <script src="/assets/toastify/toastify.js"></script>
    </head>
    <body>
        <div class="container-fluid">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6"></div>
                        <!-- /.col -->
                        <div class="col-md-6">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb float-md-end">
                                    <li class="breadcrumb-item">
                                        <a
                                            href="javascript:void(0)"
                                            data-bs-toggle="modal"
                                            data-bs-target="#staticBackdrop"
                                            >Inicio</a
                                        >
                                        <!-- Modal -->
                                        <div
                                            class="modal fade"
                                            id="staticBackdrop"
                                            data-bs-backdrop="static"
                                            data-bs-keyboard="false"
                                            tabindex="-1"
                                            aria-labelledby="staticBackdropLabel"
                                            aria-hidden="true"
                                        >
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1
                                                            class="modal-title fw-bold fs-5"
                                                            id="staticBackdropLabel"
                                                        >
                                                            ¿Estás seguro de que
                                                            deseas ir al inicio?
                                                        </h1>
                                                        <button
                                                            type="button"
                                                            class="btn-close"
                                                            data-bs-dismiss="modal"
                                                            aria-label="Close"
                                                        ></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        Si regresas al inicio,
                                                        los datos que hayas
                                                        ingresado en este
                                                        formulario no se
                                                        guardarán.
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button
                                                            type="button"
                                                            class="btn btn-secondary"
                                                            data-bs-dismiss="modal"
                                                        >
                                                            Cancelar
                                                            <i
                                                                class="fa-solid fa-ban"
                                                            ></i>
                                                        </button>
                                                        <a
                                                            href="/"
                                                            class="btn btn-primary"
                                                            role="button"
                                                            >Confirmar
                                                            <i
                                                                class="fa-solid fa-check"
                                                            ></i
                                                        ></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li
                                        class="breadcrumb-item active"
                                        aria-current="page"
                                    >
                                        Creación de Plan
                                    </li>
                                    <li
                                        class="breadcrumb-item active"
                                        aria-current="page"
                                    >
                                        Información General
                                    </li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                    <!-- /.row -->
                </div>
                <!-- /.container-fluid -->
            </div>

            <!-- Hoverable rows start -->
            <section class="container">
                <header>1. Información General</header>
                <form
                    id="familiaForm"
                    class="form"
                    method="POST"
                    autocomplete="off"
                >
                    <div class="row">
                        <div class="col-md-6 col-12 mb-3">
                            <div class="form-group">
                                <label for="nombreFam" style="font-weight: bold"
                                    >Nombre de la familia acogiente</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="nombreFam"
                                    id="nombreFam"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label
                                    for="direccionFam"
                                    style="font-weight: bold"
                                    >Dirección del domicilio</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="direccionFam"
                                    id="direccionFam"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            <div class="form-group">
                                <label for="telFam" style="font-weight: bold"
                                    >Número de teléfono familia acogiente</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="telFam"
                                    id="telFam"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="provincia" style="font-weight: bold"
                                    >Provincia</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="provincia"
                                    id="provincia"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            <div class="form-group">
                                <label for="canton" style="font-weight: bold"
                                    >Cantón</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="canton"
                                    id="canton"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-group">
                                <label for="barrio" style="font-weight: bold"
                                    >Comunidad/Barrio/Recinto:</label
                                >
                                <select
                                    class="form-control mb-2"
                                    id="selectOption"
                                    name="opcionBcr"
                                    style="font-weight: bold"
                                    onchange="updatePlaceholder()"
                                >
                                    <option selected>
                                        Seleccione una opción
                                    </option>
                                    <option value="comunidad">Comunidad</option>
                                    <option value="barrio">Barrio</option>
                                    <option value="recinto">Recinto</option>
                                </select>
                                <input
                                    type="text"
                                    class="form-control mb-3"
                                    name="nombreBcr"
                                    id="barrio"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6 col-12 mb-5">
                            <div class="form-group">
                                <label for="numCasa" style="font-weight: bold"
                                    >Número de casa</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    name="numCasa"
                                    id="numCasa"
                                    required
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row botonsform">
                        <div class="col">
                            <a
                                href="javascript:void(0)"
                                data-bs-toggle="modal"
                                data-bs-target="#staticBackdrop"
                                class="btn btn-secondary"
                                >Regresar <i class="fa-solid fa-rotate-left"></i
                            ></a>
                            <button
                                type="submit"
                                id="guardarYContinuar"
                                class="btn btn-success"
                            >
                                Siguiente
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </section>
        </div>

        <!-- Enlazar jQuery localmente -->
        <script src="/assets/js/jquery-3.7.1.min.js"></script>
        <!-- Enlazar Bootstrap JS -->
        <script src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>

        <!-- JavaScript to update the placeholder -->
        <script>
            function updatePlaceholder() {
                const selectOption = document.getElementById("selectOption");
                const barrioInput = document.getElementById("barrio");
                barrioInput.placeholder = `Nombre de ${
                    selectOption.options[selectOption.selectedIndex].text
                }`;
            }
        </script>

        <script>
            document
                .getElementById("guardarYContinuar")
                .addEventListener("click", async function (event) {
                    event.preventDefault(); // Prevenir que el formulario se envíe y se recargue

                    // Obtiene los valores de cada campo
                    const nombreFam = document
                        .getElementById("nombreFam")
                        .value.trim();
                    const direccionFam = document
                        .getElementById("direccionFam")
                        .value.trim();
                    const telFam = document
                        .getElementById("telFam")
                        .value.trim();
                    const provincia = document
                        .getElementById("provincia")
                        .value.trim();
                    const canton = document
                        .getElementById("canton")
                        .value.trim();
                    const opcionBcr =
                        document.getElementById("selectOption").value;
                    const nombreBcr = document
                        .getElementById("barrio")
                        .value.trim();
                    const numCasa = document
                        .getElementById("numCasa")
                        .value.trim();

                    // Validación básica de los campos
                    if (
                        !nombreFam ||
                        !direccionFam ||
                        !telFam ||
                        !provincia ||
                        !canton ||
                        !nombreBcr ||
                        !numCasa
                    ) {
                        // Mostrar el toast de advertencia
                        Toastify({
                            text: "Por favor, complete todos los campos",
                            duration: 1000, // Duración del toast (1 segundos)
                            close: true,
                            gravity: "top", // Ubicación del toast en la pantalla
                            position: "right",
                            backgroundColor: "orange", // Color de fondo para advertencia
                        }).showToast();
                        return;
                    }

                    if (isNaN(telFam)) {
                        // Mostrar el toast de advertencia si el teléfono no es numérico
                        Toastify({
                            text: "El número de teléfono debe ser numérico",
                            duration: 1200, // Duración del toast (1 segundos)
                            close: true,
                            gravity: "top", // Ubicación del toast en la pantalla
                            position: "right",
                            backgroundColor: "orange", // Color de fondo para advertencia
                        }).showToast();
                        return;
                    }

                    // Datos a enviar
                    const data = {
                        nombreFam: nombreFam,
                        direccionFam: direccionFam,
                        telFam: telFam,
                        provincia: provincia,
                        canton: canton,
                        opcionBcr: opcionBcr,
                        nombreBcr: nombreBcr,
                        numCasa: numCasa,
                    };

                    // Envío de datos al servidor con fetch
                    try {
                        const response = await fetch("/informacion_general", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                // Token CSRF para Lumen (si se usa en el proyecto)
                                "X-CSRF-TOKEN": document.querySelector(
                                    'meta[name="csrf-token"]'
                                )
                                    ? document.querySelector(
                                          'meta[name="csrf-token"]'
                                      ).content
                                    : "",
                            },
                            body: JSON.stringify(data),
                        });

                        const responseData = await response.json();

                        if (responseData.success) {
                            // Almacenar cod_familia en localStorage
                            localStorage.setItem(
                                "codFamilia",
                                responseData.cod_familia
                            );

                            // Mostrar el toast con el mensaje de éxito
                            Toastify({
                                text: responseData.message,
                                duration: 1000, // Duración del toast (1 segundos)
                                close: true,
                                gravity: "top", // Ubicación del toast en la pantalla
                                position: "right",
                                backgroundColor: "green",
                            }).showToast();

                            // Esperar a que el toast termine antes de redirigir (1 segundos)
                            setTimeout(() => {
                                window.location.href = "amenazas";
                            }, 1000); // Espera 1 segundos antes de redirigir
                        } else {
                            // Mostrar el toast con el mensaje de error
                            Toastify({
                                text: responseData.message,
                                duration: 1000, // Duración del toast (1 segundos)
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "red",
                            }).showToast();
                        }
                    } catch (error) {
                        console.error("Error:", error);
                        // Mostrar un toast de error en caso de fallo en la comunicación
                        Toastify({
                            text: "Hubo un problema con la solicitud",
                            duration: 1000, // Duración del toast (3 segundos)
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "red",
                        }).showToast();
                    }
                });
        </script>
    </body>
</html>
